<template name="showPosts">
  <center class="unpublishWebPage" style="position: fixed;top: 0;color: grey;background-color: #111;bottom: 0;z-index: 3000;left: 0;right: 0;padding-top: 50%;display:none;">
		抱歉，您访问的帖子已被删除。
	</center>
  {{> pcommentInput}}
  <div class="showBgColor">
    <div class="showPostsBox">
    <div class="showPosts">

      <div id="blur_overlay" style="position: absolute; opacity: 0.5; z-index: -1; width:100%; background-color:white;">
          {{> spinner}}
      </div>
      <div class="head">
          <div class="leftButton" style="left: 0;margin: 0;">
            {{#if displayBackBtn}}
            <i class="fa fa-angle-left fa-fw back" style="padding: 0;margin-top: 3px;width: auto;padding-left: 10px;"></i>
            {{/if}}
            {{#if displayForwardBtn}}
            <i class="fa fa-angle-right fa-fw forward" style="padding: 0;margin-top: 3px;width: auto;font-size: 2em;float: right;"></i>
            <div class="forward" style="float: right;font-size: 14px;margin-left: 10px;">前进</div>
            {{/if}}
            {{#if displayBackBtn}}
            <span class="back" style="font-size: 14px;color: grey;bottom: 5px;">后退</span>
            {{/if}}
          </div>
          <div class="rightButton pub-me-post" style="font-weight:bold; color: red;">点我创作</div>
          <!--<div class="rightButton" style="font-weight:bold; color: red;" onclick=" trackEvent('Download','from Post Header'); window.open('http://cdn.tiegushi.com', '_system');">点我创作</div>-->
        {{#if displayFollowBtn}}
        <div id="SubscribeAuthor" style="left:64px;"><i class="fa fa-plus"></i> 关注</div>
        {{else}}
        <div id="SubscribeAuthor"><i class="fa fa-plus"></i> 关注</div>
        {{/if}}
        <div class="user">
          {{#if isMobile}}
            <img class="icon" src="{{ownerIcon}}" width='25' height='25'>
          {{/if}}
          <span class="name userDashboard">{{ownerName}}</span>
          <div class="createAt userDashboard">{{time_diff createdAt}}</div>
        </div>

        {{#if isMobile}}
          <div class="rightDropMenu dropdown">
            {{#if isMyPost}}
              <button class="dropdown-toggle btn btn-flat" id="menu1" data-toggle="dropdown" style="padding-right: 5px;">操作</button>
            {{else}}
              <button class="dropdown-toggle btn btn-flat" id="menu1" data-toggle="dropdown" style="padding-right: 5px;">分享</button>
            {{/if}}
            <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
              {{#if isMyPost}}
                <li role="presentation"><a id="unpublish" role="menuitem" tabindex="-1" ><i class="fa fa-file-o"></i>&nbsp;取消发表</a></li>
                <li role="presentation"><a id="edit" role="menuitem" tabindex="-1" ><i class="fa fa-pencil fa-fw"></i>编辑</a></li>
                <li role="presentation" class="divider"></li>
              {{/if}}
              <li role="presentation"><a id="WXSessionShare" role="menuitem" tabindex="-1" ><i class="fa fa-weixin fa-fw"></i>分享给微信好友</a></li>
              <li role="presentation"><a id="WXTimelineShare" role="menuitem" tabindex="-1" ><i class="fa fa-weixin fa-fw"></i>分享到微信朋友圈</a></li>
              <li role="presentation"><a id="QQShare" role="menuitem" tabindex="-1" ><i class="fa fa-qq fa-fw"></i>分享到QQ</a></li>
              <li role="presentation"><a id="socialShare" role="menuitem" tabindex="-1" ><i class="fa fa-share-alt fa-fw"></i>分享到更多应用</a></li>
            </ul>
          </div>
        {{/if}}
      </div>
      <div class="content">
          {{#if getAbstractSentence}}
              <div class="post_header">
                  <div class="post_abstract">
                      <div class="abstract_sentence"><span style="white-space: pre-wrap;">{{getAbstractSentence}}</span></div>
                      <div class="abstract_chapter">――节选自 <a href="#" class="goChapter">第{{getAbstractSentenceIndex}}段 {{title}}{{#if addontitle}}：{{addontitle}}{{/if}}</a></div>
<!--                      <div class="abstract_comment">
                        {{#if clickedCommentOverlayThumbsDown}}
                          <img class="abstract_thumbsDown" src="/thumbsDownBlue.png" width="20" height="20">
                        {{else}}
                          <img class="abstract_thumbsDown" src="/thumbsDownGray.png" width="20" height="20">
                        {{/if}}
                        {{#if clickedCommentOverlayThumbsUp}}
                          <img class="abstract_thumbsUp" src="/thumbsUpPink.png" width="20" height="20">
                        {{else}}
                          <img class="abstract_thumbsUp" src="/thumbsUpGray.png" width="20" height="20">
                        {{/if}}
                          <img class="abstract_commentGray" src="/commentGray.png" width="20" height="20">
                    </div>-->
                  </div>
              </div>
          {{/if}}
        
        {{#if showImporting}}
        <div class="importing">您的故事服务器正在优化中，完成后此消息会消失...</div>
        {{/if}}
        <div id="wrapper">
          <div class="mainImage" id="{{_id}}" style="height:{{getMainImageHeight}}px;">
            <img id="wx-img" class="scale item" src="{{mainImage}}" draggable="false" style="min-height: 100%;position:absolute;{{mainImageStyle}}" >
            <header>
              <h2 id="wx-title" class="title">{{title}}</h2>
              <h4 id="wx-con" class="addontitle">{{addontitle}}</h4>
            </header>
          </div>
        </div>
        <div class="contentList">
          {{#if mainText}}
            <div class="text" style="height: initial;">{{mainText}}</div>
          {{/if}}
        </div>

        <div class="gridster">
          <div id="test">
              {{#if displayPostContent}}
                  {{#each getPub}}
                      {{>postItem}}
                  {{/each}}
              {{/if}}
          </div>
        </div>
      </div>
    </div>
    {{#if haveUrl}}
    <div id="ViewOnWeb"><i class="fa fa-globe"></i>     阅读原文</div>
    {{/if}}
    {{#if withAfterPostIntroduce}}
      <div class="write">
        <p class="author">Write by <span class="spc">{{ownerName}}</span></p>
        <a href="#" class="showPhoto">  <img src="{{ownerIcon}}"></a>
      </div>
      <div class="nav"></div>
      <div class="hotitle">
        <h2>热门文章<span>（下载“故事贴”查看更多精彩内容）</span></h2>
      </div>
      <div class="hotcont">
        <dl>
          <dt><img src="/img/demo-1.jpg" width="100" height="100"> </dt>
          <dd>哪些年，我们在一起</dd>
        </dl>
        <dl>
          <dt><img src="/img/demo-1.jpg" width="100" height="100"> </dt>
          <dd>哪些年，我们在一起</dd>
        </dl>
        <dl>
          <dt><img src="/img/demo-1.jpg" width="100" height="100"> </dt>
          <dd>哪些年，我们在一起</dd>
        </dl>
      </div>
      <a href="#" class="button-1"><img src="/img/icon-2.jpg" width="300"></a>
      <div class="writeBottom">
        <p>本文由史上最好用的图文排版APP<span>故事贴</span>支持创作</p>
      </div>
    {{/if}}
    <div onclick="trackEvent('Download','from Post Tail');window.open('http://cdn.tiegushi.com', '_system');"><img src="/img/download.png" style="width:90%;margin-left:5%;"></div>
    {{#unless isMyPost}}
      <div class="showPostsFollowMe">
        {{#if inWeiXin}}
        <p>更多精彩内容，敬请点击关注<span><a><i class="fa fa-weixin"></i>故事贴</a></span>微信公众号</p>
        {{else}}
        <p>更多精彩内容，请搜索关注<span><a><i class="fa fa-weixin"></i>故事贴</a></span>微信公众号</p>
        {{/if}}
      </div>
    {{/unless}}
    {{#if isCordova}}
    {{#unless isMyPost}}
    <div id="report">举报</div>
    {{/unless}}
    {{/if}}
    <div class="showPostsLine"></div>
      {{> commentContent}}
      </div>
      {{#if withSocialBar}}
        <div class="superChatIntroduce">
            <p>故事贴无法获得微信信息，请放心使用</p>
        </div>
        {{> socialContent}}
      {{/if}}
    </div>
<!--    {{> postFooter}}-->
  <div class="popUpBox" style="{{popUpBoxStyle}}">
  {{#if displayCommentInputBox}}
  <div class="commentInputBox">
    <header class="bottomBorder">
      {{#if currentUser}}
        <div class="title">评论</div>
      {{else}}
        <div class="title">匿名评论</div>
      {{/if}}
      <div id="finish" class="leftButton">取消</div>
      <div id="submit" class="rightButton">发送</div>
    </header>
    <form id="new-reply" name="new-reply" class="new-reply">
      <textarea name="comment" class="commentArea" placeholder="说点什么..." type="text" value="{{refcomment}}"></textarea>
      <div class="footer"><span class="change">换</span></div>
    </form>
  </div>
  {{/if}}
  {{#if withSectionMenu}}
      <div class="section-toolbar" id="{{_id}}" style='visibility: hidden;'>
          {{#if withSectionShare}}
              <a href="#" class='section-forward' action="section-forward"><i>转发本段</i></a>
          {{/if}}
          {{#if withPostTTS}}
              <a href="#" class='post-tts' action="post-tts"><i>朗读</i></a>
          {{/if}}
      </div>
  {{/if}}
  {{> userProfileBox}}
  {{> SectionReviewBox}}
  </div>

  <!-- 此部分在wifi情况下，会导致微信分享端口被重写，url改变为阅览室地址，临时注销掉，待解决此问题后再开放。
  {{#if hiddenChatLoad}}
    <iframe src='{{chatUrl}}' style="width:0;height:0;border:0; border:none;"></iframe>
  {{/if}}-->
  
  <div class="shareAlertBackground"></div>
  <div class="shareTheReadingRoom">
    <div class="title">是否将此贴分享给故事贴的读友圈？</div>
    <div class="banner">
      <div class="btnYes">分享</div>
      <div class="btnNo">取消</div>
    </div>
  </div>
  {{> SubscribeAuthor}}
</template>
<template name="postFooter">
  <div id="postFooter" class="showPostsFooter">
    <div class="commentList">
      <span class="minHeart"><i class="fa fa-thumbs-up"></i>{{heart}}</span>
      <span class="minComment"><i class="fa fa-comment"></i>{{comment}}</span>
    </div>
    <input readOnly name="comment" class="comment" placeholder="说点什么..." type="text" value="{{refcomment}}">
    <div class="buttons">
      <span class="refresh">换</span>
      {{#if blueHeart}}
        <span class="blueHeart"><i class="fa fa-thumbs-up" style="color:#00c4ff;"></i></span>
      {{else}}
        <span class="heart"><i class="fa fa-thumbs-o-up" style="color:#00c4ff;"></i></span>
      {{/if}}
    </div>
  </div>
</template>

<template name="pCommentsList">
  <div class="pcommentsList" style="display:none;">
      <div class="pcomment">
        {{#if hasPcomments}}
         {{#each pcomments}}
          <div class="eachComment">
            <div class="bubble">
              <span class="personName">{{username}}:</span><br>
              <span class="personSay">{{content}}</span>
            </div>
            <span class="time round">{{time_diff createdAt}}</span>
          </div>
         {{/each}}
       {{else}}
         <div class="banner">快来抢沙发～～(￣▽￣)"</div>
       {{/if}}
      </div>
      <div class="input-group">
        <input type="text" id="pcommitReport" autofocus="autofocus" class="form-control" maxlength="180" placeholder="评论" />
        <input type="submit" value="发表" id="pcommitReportBtn">
      </div>
  </div>
  <div onclick="hidePcomments()" class="alertBackground"></div>
    <script>
       function hidePcomments(){
         $('.showBgColor').removeAttr('style')
         $(window).scrollTop(0-Session.get('backgroundTop'))
         $('.pcommentsList,.alertBackground').fadeOut(300);
         Session.set('backgroundTop','')
       }
    </script>
</template>

<template name="pcommentInput">
  <div class="pcommentInput" style="display:none;">
      <div class="input-group">
        <input type="text" id="pcommitReport" autofocus="autofocus" class="form-control" maxlength="180" placeholder="评论" />
        <div onclick="pcommitReport()" id="pcommitReportBtn">发送</div>
      </div>
  </div>
  <div onclick="hidePcomments()" class="alertBackground"></div>
    <script>
       function hidePcomments(){
         $('.showBgColor').removeAttr('style');
         $(window).scrollTop(0-Session.get('backgroundTop'));
         $('.pcommentInput,.alertBackground').fadeOut(300);
         Session.set('backgroundTop','')
       }
       function pcommitReport(e, t) {
          var content, i, pcommentJson, pcomments, position, post, postId, userIcon, userId, username;
          i = Session.get("pcommentIndexNum");
          content = $('#pcommitReport').val();
          postId = Session.get("postContent")._id;
          post = Session.get("postContent").pub;

          var mqtt_msg = {"type": "postcomment", "message": " 评论了此段 \"" + Session.get("postContent").pub[i].text + '": ' + content, "postid": Session.get('postContent')._id};

          mqtt_msg.message = Meteor.user().profile.fullname + mqtt_msg.message;

          mqtt_connection=mqtt.connect('ws://rpcserver.raidcdn.com:80');
          mqtt_connection.on('connect',function() {
            mqtt_connection.publish('all', JSON.stringify(mqtt_msg));
          });

          if (favp = FavouritePosts.findOne({postId: postId, userId: Meteor.userId()})) {
            FavouritePosts.update({_id: favp._id}, {$set: {updateAt: new Date()}});
          }
          else {
            FavouritePosts.insert({postId: postId, userId: Meteor.userId(), createdAt: new Date(), updateAt: new Date()});
          }

//          if (withSponserLinkAds) {
//            position = 1 + (post.length / 2);
//          }
//          if (i > position) {
//            i -= 1;
//          } else {
//            i = i;
//          }
          if (content === "") {
            $('.showBgColor').removeAttr('style');
            $(window).scrollTop(0 - Session.get('backgroundTop'));
            $('.pcommentInput,.alertBackground').fadeOut(300);
            return false;
          }
          if (Meteor.user()) {
            if (Meteor.user().profile.fullname) {
              username = Meteor.user().profile.fullname;
            } else {
              username = Meteor.user().username;
            }
            userId = Meteor.user()._id;
            userIcon = Meteor.user().profile.icon;
          } else {
            username = '匿名';
            userId = 0;
            userIcon = '';
          }
          if (!post[i].pcomments || post[i].pcomments === void 0) {
            pcomments = [];
            post[i].pcomments = pcomments;
          }
          pcommentJson = {
            content: content,
            username: username,
            userId: userId,
            userIcon: userIcon,
            createdAt: new Date()
          };
          // post[i].pcomments.push(pcommentJson);
          Posts.update({
            _id: postId
          }, {
            $push: {
              [`pub.${i}.pcomments`]: pcommentJson
            },
            $set: {
              "ptype": "pcomments",
              "pindex": i
            }
          }, function(error, result) {
            if (error) {
              return console.log(error.reason);
            } else {
              return console.log("success");
            }
          });
          $('#pcommitReport').val('');
          $("#pcommitReport").attr("placeholder", "评论");
          $('.showBgColor').removeAttr('style');
          $(window).scrollTop(0 - Session.get('backgroundTop'));
          $('.pcommentInput,.alertBackground').fadeOut(300);
          refreshPostContent()
          return false;
        }

    </script>
</template>
<template name="SectionReviewBox">
    {{#if displaySectionReviewBox}}
    <div class="commentOverlay">
        <div class="banner">您对TA转发的这段文章有什么看法？</div>
        <div class="commentOverlayInputGroup">
          <div class="input-group">
            <input type="text" id="overlayPcommitReport" autofocus="autofocus" class="form-control" maxlength="180" placeholder="输入您的评论" />
            <div  id="overlayPcommitReportBtn">点评</div>
          </div>
        </div>
        <div class="commentOverlayBtn">
          <span class="commentOverlayLater" style="color: #CACDD1;font-weight: bold;">稍后再评</span>
            {{#if clickedCommentOverlayThumbsUp}}
            <img style="margin:0 20%" class="thumbsUp" src="/thumbsUpPink.png" width="16" height="16">
            {{else}}
            <img style="margin:0 20%" class="thumbsUp" src="/thumbsUpGray.png" width="16" height="16">
            {{/if}}
            {{#if clickedCommentOverlayThumbsDown}}
            <img class="thumbsDown" src="/thumbsDownBlue.png" width="16" height="16">
            {{else}}
            <img class="thumbsDown" src="/thumbsDownGray.png" width="16" height="16">
            {{/if}}
        </div>
    </div>
    {{/if}}
</template>

<template name="SubscribeAuthor">
  <div class="subscribeAutorPage">
    <div class="bg"></div>
    <div class="content">
        <div class="header">关注作者</div>
        <div class="body">
          <textarea id="email" cols="10" rows="2" placeholder="请留下您的QQ号或者邮箱地址，您将收到关注作者的新文章"></textarea>
          <p class="help-block"></p>
        </div>
        <div class="footer">
          <div class="btn cannelBtn">取消</div>
          <div class="btn okBtn">确定</div>
        </div>
    </div>
  </div>
</template>