<template name="discover">
  <div class="comFadeIn discover" style="background:#efeff4;">
    {{#if hasDiscover}}
      <!--朋友圈 start-->
      <!--
      <div class="disTop">
        <div class="disBg"></div>
        <div class="disLeft">
          <p class="disname">朋友圈</p>
          {{#if showSuggestPosts}}
              <p class="disdesc">看过当前帖子的朋友看过的帖子，您都看过了，特意为您推荐以下您没看过帖子...</p>
          {{else}}
              <p class="disdesc">看过当前帖子的朋友，还看过...</p>
          {{/if}}
        </div>
      </div>
      -->
      <div  style="background:#fff;padding: 10px 0;"> 
      {{>lpcomments}}
      </div>
      <div class="discover-top">
          <div class="discover-bg" style="background:#efeff4;"></div>
          <div class="discover-con" style="background:#efeff4;">
            <img src="/book-icon.png">
            <span>看过该帖的朋友还看过...</span>
          </div>
      </div>
      {{> recommends}}
      {{>moments}}
      <!--朋友圈 end-->
    {{/if}}
  </div>
</template>
<template name="recommends">
    <div class="recommends">
        <ul id="wrapper"  class="swipe-delete">
            {{#each recommends}}
                <li class="elementBox" id="{{recommendPostId}}" style="border-bottom: 1px dashed #d9d9d9;">
                    <div class="behind">
                        <a href="#" class="swipeElement ui-btn delete-btn" id="{{_id}}">删除</a>
                    </div>
                    <a id="list" class="swipeElement">
                    <div class="icon">
                        <img src="{{recommendUserIcon}}" width="40" height="40" style="border-radius:4px;"/>
                    </div>
                    <div class="user_name" style="background:#efeff4;">
                        <h2 style="padding-top:2px;">{{recommendUserName}}&nbsp;</h2>
                        <h3>看过<span>{{targetPostTitle}}</span>后，推荐您阅读</h3>
                        <div class="readpost">
                            <dl>
                                <dt>
                                    <img class="post_pic" src="{{recommendPostMainImage}}" width="64" height="64"/>
                                    <!--<div class="red_spot"></div>-->
                                </dt>
                               <dd>
                                    <h2>{{recommendPostTitle}}</h2>
                                    <p>发表：{{time_diff recommendPostCreatedAt}}</p>
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div class="clear"></div>
                </a>
              </li>            
            {{/each}}
        </ul>
    </div>
    <script>
      $(function() {
        function prevent_default(e) {
            e.preventDefault();
        }
        function disable_scroll() {
            $(document).on('touchmove', prevent_default);
        }
        function enable_scroll() {
            $(document).unbind('touchmove', prevent_default)
        }
        var x, elementId;
        $('body')
            .on('touchstart','.swipe-delete li > a', function(e) {
                console.log(e.originalEvent.pageX)
                $('.swipe-delete li > a.open').css('left', '0px').removeClass('open') // close em all
                $(e.currentTarget).addClass('open')
                x = e.originalEvent.targetTouches[0].pageX // anchor point
            })
            .on('touchmove','.swipe-delete li > a', function(e) {
                var change = e.originalEvent.targetTouches[0].pageX - x
                change = Math.min(Math.max(-100, change), 0) // restrict to -100px left, 0px right
                e.currentTarget.style.left = change + 'px'
                if (change < -10) disable_scroll() // disable scroll once we hit 10px horizontal slide
            })
            .on('touchend','.swipe-delete li > a', function(e) {
                var left = parseInt(e.currentTarget.style.left)
                var new_left;
                if (left < -35) {
                    new_left = '-100px'
                } else if (left > 35) {
                    new_left = '0px' //右滑动
                } else {
                    new_left = '0px'
                }
                // e.currentTarget.style.left = new_left
                $(e.currentTarget).animate({left: new_left}, 200)
                enable_scroll()
            });
        $('body').on('touchend','.swipe-delete .delete-btn', function(e) {
            e.preventDefault()
            console.log(e.currentTarget.id);
            elementId = e.currentTarget.id;
            console.log(elementId);
            var userLists = [];
            var readUsers = Recommends.findOne({_id:elementId}).readUsers;
            if(readUsers){
               userLists = readUsers;
            }
            userLists.push(Meteor.userId());
            $(this).parents('li').slideUp('fast', function() {
                $(this).remove()
                Recommends.update({_id:elementId},{$set: {readUsers: userLists}});
                // Feeds.update({_id:elementId},{$set: {checked:true}})
            })
        })
    });
    </script>
</template>
<template name="lpcomments">
    {{#if hasLpcoments}}
    <div class="discover-top"  style="background:#fff;">
          <div class="discover-bg"></div>
          <div class="discover-con">
            <img src="/frends-msg.svg">
            <span>朋友圈消息</span>
          </div>
    </div>
    <div class="lpcomments">
        <ul id="wrapper"  class="swipe-delete">
            {{#each lpcomments}}
                {{#if isShareFeed}}
                    <li class="elementBox">
                      <div class="behind">
                        <a href="#" class="swipeElement ui-btn delete-btn" id="{{_id}}">删除</a>
                      </div>
                      <a id="list" class="swipeElement">
                        <div class="icon">
                            <img src="{{ownerIcon}}" width="40" height="40"/>
                        </div>
                        <div class="user_name">
                            <h2>{{ownerName}}:&nbsp;<span>{{ReadAfterShare}}人读过您的转发</span></h2>
                            <div class="readpost">
                                <dl>
                                    <dt>
                                        <img class="post_pic" src="{{mainImage}}" width="40" height="40"/>
                                    <div class="red_spot"></div>
                                    </dt>
                                    <dd>{{postTitle}}  {{addontitle}}</dd>
                                </dl>
                            </div>
                            <span style="margin:0;">{{time_diff createdAt}}</span>
                        </div>
                        <div class="clear"></div>
                    </a>
                  </li>
                {{else}}
                    {{#if isCommentShare}}
                        <li class="elementBox">
                            <div class="behind">
                                <a href="#" class="swipeElement ui-btn delete-btn" id="{{_id}}">删除</a>
                            </div>
                            <a id="list" class="swipeElement">
                                <div class="icon">
                                    <img src="{{ownerIcon}}" width="40" height="40"/>
                                </div>
                                <div class="user_name">
                                    {{#if pindexText}}
                                    <h2>{{ownerName}}&nbsp;<span>点评了您转发的段落：</span></h2>
                                    <div style="font-sze:10px;">"{{pindexText}}"</div>
                                    {{else}}
                                    <h2>{{ownerName}}&nbsp;<span>点评了您的转发</span></h2>
                                    {{/if}}
                                    <div class="readpost">
                                        <dl>
                                            <dt>
                                                <img class="post_pic" src="{{mainImage}}" width="40" height="40"/>
                                            <div class="red_spot"></div>
                                            </dt>
                                            <dd>{{postTitle}}  {{addontitle}}</dd>
                                        </dl>
                                    </div>
                                    <span style="margin:0;">{{time_diff createdAt}}</span>
                                </div>
                                <div class="clear"></div>
                            </a>
                        </li>
                    {{else}}
                        <li class="elementBox">
                        <div class="behind">
                          <a href="#" class="swipeElement ui-btn delete-btn" id="{{_id}}">删除</a>
                        </div>
                        <a id="list" class="swipeElement">
                            <div class="icon">
                                <img src="{{ownerIcon}}" width="40" height="40"/>
                            </div>
                            <div class="user_name">
                                {{#if pindexText}}
                                  {{#if meComment}}
                                  <h2>{{ownerName}}&nbsp;<span>和您点评了同一段落：</span></h2>
                                  <div style="font-sze:10px;">"{{pindexText}}"</div>
                                  {{else}}
                                  <h2>{{ownerName}}&nbsp;<span>也点评了此故事：</span></h2>
                                  <div style="font-sze:10px;">"{{pindexText}}"</div>
                                  {{/if}}
                                {{else}}
                                  <h2>{{ownerName}}&nbsp;<span>也点评了此故事</span></h2>
                                {{/if}}
                                <div class="readpost">
                                    <dl>
                                        <dt>
                                            <img class="post_pic" src="{{mainImage}}" width="40" height="40"/>
                                            <div class="red_spot"></div>
                                        </dt>
                                        <dd>{{postTitle}}  {{addontitle}}</dd>
                                    </dl>
                                </div>
                                <span style="margin:0;">{{time_diff createdAt}}</span>
                            </div>
                            <div class="clear"></div>
                        </a>
                        </li>
                    {{/if}}
                {{/if}}
            {{/each}}
        </ul>
    </div>
    <script>
      $(function() {
        function prevent_default(e) {
            e.preventDefault();
        }
        function disable_scroll() {
            $(document).on('touchmove', prevent_default);
        }
        function enable_scroll() {
            $(document).unbind('touchmove', prevent_default)
        }
        var x, elementId;
        $('body')
            .on('touchstart','.swipe-delete li > a', function(e) {
                console.log(e.originalEvent.pageX)
                $('.swipe-delete li > a.open').css('left', '0px').removeClass('open') // close em all
                $(e.currentTarget).addClass('open')
                x = e.originalEvent.targetTouches[0].pageX // anchor point
            })
            .on('touchmove','.swipe-delete li > a', function(e) {
                var change = e.originalEvent.targetTouches[0].pageX - x
                change = Math.min(Math.max(-100, change), 0) // restrict to -100px left, 0px right
                e.currentTarget.style.left = change + 'px'
                if (change < -10) disable_scroll() // disable scroll once we hit 10px horizontal slide
            })
            .on('touchend','.swipe-delete li > a', function(e) {
                var left = parseInt(e.currentTarget.style.left)
                var new_left;
                if (left < -35) {
                    new_left = '-100px'
                } else if (left > 35) {
                    new_left = '0px' //右滑动
                } else {
                    new_left = '0px'
                }
                // e.currentTarget.style.left = new_left
                $(e.currentTarget).animate({left: new_left}, 200)
                enable_scroll()
            });
        $('body').on('touchend','.swipe-delete .delete-btn', function(e) {
            e.preventDefault()
            console.log(e.currentTarget.id);
            elementId = e.currentTarget.id;
            $(this).parents('li').slideUp('fast', function() {
                $(this).remove()
                Feeds.update({_id:elementId},{$set: {checked:true}})
            })
        })
    });
    </script>
    {{/if}}
</template>
<template name="moments">
      <div class="moments">
            {{#if loading}}
                <div>正在加载中...</div>
            {{/if}}
            {{#if loadError}}
                <div>加载失败，请检查网络设置或稍后重试</div>
            {{/if}}
            {{#if newLayoutMoment}}
                {{#newLayoutContainer layoutId=onPostId src="moments" container=".moments"}}
                    {{#if showSuggestPosts}}
                    {{#each suggestPosts}}
                        {{#unless hideSuggestPost}}
                            {{#newLayoutElement layoutId=onPostId displayId=_id src="moments" container=".moments"}}
                                <div class="img_placeholder">
                                    <img class="mainImage" src="{{mainImage}}" />
                                </div>
    <!--                                <header>
                                  <p class="title">{{title}}</p>
                                  <p class="addontitle">{{addontitle}}</p>
                                </header>-->
                                <div class="pin_content">
    <!--                                  <span><img class="userIcon" src="{{userIcon}}" width="35" height="35" /></span>-->
                                  <p class="title">{{title}}</p>
                                  <p class="addontitle">{{addontitle}}</p>
                                  <h1 class="username">{{ownerName}}  <span>发布</span>{{#if withSuggestAlreadyRead}}<button class="suggestAlreadyRead"><i class="fa fa-times"></i></button>{{/if}}</h1>
    <!--                                  <h2>发布了一个故事</h2>-->
    <!--                                  <b>{{time_diff createdAt}}</b>-->
                                </div>
                            {{/newLayoutElement}}
                        {{/unless}}
                    {{/each}}
                    {{/if}}
                    {{#each moments}}
                        {{#unless hidePost}}
                            {{#newLayoutElement layoutId=onPostId displayId=readPostId src="moments" container=".moments"}}
                                <div class="img_placeholder">
                                    <img class="mainImage" src="{{mainImage}}" />
                                </div>
    <!--                                <header>
                                  <p class="title">{{title}}</p>
                                  <p class="addontitle">{{addontitle}}</p>
                                </header>-->
                                <div class="pin_content">
                                  <p class="title">{{title}}</p>
                                  <p class="addontitle">{{addontitle}}</p>
    <!--                                  <span><img class="userIcon" src="{{userIcon}}" width="35" height="35" /></span>-->
    <!--                                  <h2>阅读了一个故事</h2>-->
    <!--                                  <b>{{time_diff createdAt}}</b>-->
                                </div>
                                <h1 class="username">{{username}}  <span>读过</span>{{#if withSuggestAlreadyRead}}<button class="postAlreadyRead"><i class="fa fa-times"></i></button>{{/if}}</h1>
                            {{/newLayoutElement}}
                        {{/unless}}
                    {{/each}}
                {{/newLayoutContainer}}
                {{#if isLoading}}
                    <div class="loading-spinner">
                        <div class='spinner-overlay'>
                            <div class='spinner center'>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                                <div class='spinner-blade'></div>
                            </div>
                        </div>
                    </div>
                {{/if}}
            {{else}}
                <div id="wrapper">
                    {{#if showSuggestPosts}}
                        {{#each suggestPosts}}
                                <div id="list">
                                    <div class="icon">
                                        <img src="{{ownerIcon}}" width="40" height="40"/>
                                    </div>
                                    <div class="user_name">
                                        <h2>{{ownerName}}&nbsp;<span>发布了一个故事</span></h2>
                                        <div class="readpost">
                                            <dl>
                                                <dt>
                                                    <img class="post_pic" src="{{mainImage}}" width="40" height="40"/>
                                                </dt>
                                                <dd>{{title}}  {{addontitle}}</dd>
                                            </dl>
                                        </div>
                                        <p>{{time_diff createdAt}}</p>
                                    </div>
                                    <div class="clear"></div>
                                </div>
                        {{/each}}
                    {{else}}
                        {{#each moments}}
                            {{#unless hidePost}}
                            <div id="list">
                                <div class="icon">
                                    <img src="{{userIcon}}" width="40" height="40"/>
                                </div>
                                <div class="user_name">
                                    <h2>{{username}}&nbsp;<span>阅读了一个故事</span></h2>
                                    <div class="readpost">
                                        <dl>
                                            <dt>
                                                <img class="post_pic" src="{{mainImage}}" width="40" height="40"/>
                                            </dt>
                                            <dd>{{title}}  {{addontitle}}</dd>
                                        </dl>
                                    </div>
                                    <p>{{time_diff createdAt}}</p>
                                </div>
                                <div class="clear"></div>
                            </div>
                            {{/unless}}
                        {{/each}}
                    {{/if}}
                    {{#if moreResults}}
                        <div id="showMoreMomentsResults" style="margin-left: 25px;">
                            <span class="loading">加载中...</span>
                        </div>
                    {{/if}}
                </div>
            {{/if}}
      </div>
</template>
